<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viz Pilot</title>

  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-base: #0e1117;
      --bg-surface: #161b22;
      --bg-elevated: #1c2128;
      --bg-input: #0d1117;
      --border: #30363d;
      --border-subtle: #21262d;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --text-muted: #6e7681;
      --accent: #58a6ff;
      --accent-dim: #1f6feb33;
      --success: #3fb950;
      --success-dim: #23863622;
      --danger: #f85149;
      --danger-dim: #f8514922;
      --warn: #d29922;
      --warn-dim: #d2992222;
      --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
      --sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      font-family: var(--sans);
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--bg-base);
      -webkit-font-smoothing: antialiased;
    }

    /* Top bar */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 40px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }
    .topbar-brand {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
      letter-spacing: 0.5px;
    }
    .topbar-status {
      color: var(--text-muted);
      font-family: var(--mono);
      font-size: 11px;
    }

    /* Layout */
    .app {
      display: grid;
      grid-template-columns: 1fr 380px;
      grid-template-rows: auto 1fr;
      height: calc(100vh - 40px);
      overflow: hidden;
    }

    /* Panels */
    .panel {
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
    }
    .panel:last-child { border-right: none; }
    .panel-main { grid-row: 1 / -1; }
    .panel-right { grid-row: 1 / -1; overflow-y: auto; }

    /* Section blocks */
    .section {
      margin-bottom: 16px;
    }
    .section-header {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border-subtle);
    }

    /* Input area */
    .input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }
    .input-row textarea {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 13px;
      padding: 10px 12px;
      resize: vertical;
      min-height: 60px;
      max-height: 160px;
      outline: none;
      transition: border-color 0.15s;
    }
    .input-row textarea:focus {
      border-color: var(--accent);
    }
    .input-row textarea::placeholder {
      color: var(--text-muted);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: var(--sans);
      font-size: 12px;
      font-weight: 500;
      padding: 7px 14px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-primary);
      cursor: pointer;
      white-space: nowrap;
      transition: background 0.12s, border-color 0.12s;
    }
    .btn:hover { background: #272d36; border-color: #444c56; }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #0d1117;
      font-weight: 600;
    }
    .btn-primary:hover { background: #79c0ff; }
    .btn-sm { padding: 4px 10px; font-size: 11px; }
    .btn-row { display: flex; gap: 6px; margin-top: 8px; }

    /* Status line */
    .status-line {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
      min-height: 16px;
    }

    /* Chart area */
    #vis {
      background: var(--bg-surface);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 12px;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #vis .vega-embed { width: 100%; }
    #vis .vega-embed .vega-actions a {
      color: var(--text-muted) !important;
      font-size: 11px !important;
    }
    .chart-empty {
      color: var(--text-muted);
      font-size: 12px;
      text-align: center;
    }

    /* Data table */
    .data-table-wrap {
      overflow: auto;
      max-height: 220px;
      border: 1px solid var(--border);
      border-radius: 4px;
    }
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-family: var(--mono);
      font-size: 11px;
    }
    .data-table th {
      position: sticky;
      top: 0;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 6px 10px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .data-table td {
      padding: 4px 10px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-subtle);
    }
    .data-table tr:hover td { background: var(--accent-dim); }

    /* Right panel blocks */
    .meta-block {
      margin-bottom: 14px;
    }
    .meta-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .meta-value {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text-primary);
      word-break: break-all;
    }
    .meta-value--secondary { color: var(--text-secondary); }

    /* Tags / indicators */
    .tag {
      display: inline-block;
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid;
      margin-right: 4px;
    }
    .tag--ok { color: var(--success); border-color: var(--success); background: var(--success-dim); }
    .tag--warn { color: var(--warn); border-color: var(--warn); background: var(--warn-dim); }
    .tag--err { color: var(--danger); border-color: var(--danger); background: var(--danger-dim); }
    .tag--neutral { color: var(--text-secondary); border-color: var(--border); background: var(--bg-elevated); }

    /* Pre / code blocks */
    .code-block {
      background: var(--bg-input);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-secondary);
      overflow: auto;
      max-height: 200px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
    }

    /* Provenance list */
    .prov-item {
      padding: 6px 8px;
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    .prov-item-label {
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .prov-item-value {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-primary);
      margin-top: 2px;
    }

    /* Clarify area */
    .clarify-area {
      display: none;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid var(--warn);
      border-radius: 4px;
      background: var(--warn-dim);
    }
    .clarify-area label {
      font-size: 12px;
      color: var(--warn);
      font-weight: 500;
    }
    .clarify-area input {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 10px;
      outline: none;
    }
    .clarify-area input:focus { border-color: var(--accent); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #484f58; }

    /* Separator */
    .sep { border-top: 1px solid var(--border-subtle); margin: 12px 0; }
  </style>
</head>
<body>

<div class="topbar">
  <span class="topbar-brand">VIZ PILOT</span>
  <span class="topbar-status" id="topbarStatus">READY</span>
</div>

<div class="app">
  <!-- Left: main panel -->
  <div class="panel panel-main">
    <div class="section">
      <div class="section-header">Query</div>
      <div class="input-row">
        <textarea id="prompt" placeholder="Describe your chart... e.g. Plot TSLA daily close since 2024-01-01"></textarea>
      </div>
      <div class="btn-row">
        <button class="btn btn-primary" id="go">Execute</button>
        <button class="btn" id="clear">Clear</button>
      </div>
      <div class="status-line" id="statusText"></div>
      <div class="clarify-area" id="clarifyArea">
        <label id="clarifyQuestionLabel">Clarification required</label>
        <div style="display:flex; gap:8px; margin-top:6px;">
          <input id="clarifyAnswer" type="text" placeholder="Provide clarification" />
          <button class="btn btn-primary btn-sm" id="answerClarify">Submit</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Visualization</div>
      <div id="vis">
        <div class="chart-empty">No chart rendered. Execute a query to begin.</div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Data Preview</div>
      <div id="dataPreviewArea">
        <div class="data-table-wrap">
          <table class="data-table" id="dataTable">
            <thead><tr><th>No data loaded</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Right: metadata panel -->
  <div class="panel panel-right" style="background: var(--bg-surface);">
    <div class="section">
      <div class="section-header">Response</div>
      <div id="summaryArea">
        <div class="meta-block">
          <div class="meta-label">Status</div>
          <div class="meta-value meta-value--secondary">Awaiting query</div>
        </div>
      </div>
      <div class="btn-row" id="specActions" style="display:none;">
        <button class="btn btn-sm" id="downloadSpec">Download Spec</button>
        <button class="btn btn-sm" id="copySpec">Copy JSON</button>
      </div>
    </div>

    <div class="sep"></div>

    <div class="section">
      <div class="section-header">Provenance</div>
      <div id="provArea">
        <div class="meta-value meta-value--secondary">No provenance data.</div>
      </div>
    </div>

    <div class="sep"></div>

    <div class="section">
      <div class="section-header">Validation</div>
      <div id="qualityArea">
        <div class="meta-value meta-value--secondary">No validation results.</div>
      </div>
      <div id="transformActions" style="margin-top:8px;"></div>
    </div>

    <div class="sep"></div>

    <div class="section">
      <div class="section-header">Raw Spec</div>
      <div class="code-block" id="specRaw">No spec generated.</div>
    </div>
  </div>
</div>

<script>
async function postViz(payload) {
  const res = await fetch('/api/viz', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const json = await res.json().catch(() => null);
  return { status: res.status, json };
}

async function postAutofix(payload) {
  const res = await fetch('/api/viz/autofix', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const json = await res.json().catch(() => null);
  return { status: res.status, json };
}

function setTopbarStatus(text, type) {
  var el = document.getElementById('topbarStatus');
  el.textContent = text.toUpperCase();
  el.style.color = type === 'ok' ? 'var(--success)' : type === 'err' ? 'var(--danger)' : type === 'warn' ? 'var(--warn)' : 'var(--text-muted)';
}

function renderVega(spec) {
  var visEl = document.getElementById('vis');
  if (!spec || Object.keys(spec).length === 0) {
    visEl.innerHTML = '<div class="chart-empty">No renderable spec</div>';
    return;
  }
  // Use dark theme for vega
  var darkConfig = {
    background: '#161b22',
    title: { color: '#c9d1d9' },
    axis: {
      domainColor: '#30363d', gridColor: '#21262d',
      tickColor: '#30363d', labelColor: '#8b949e', titleColor: '#c9d1d9'
    },
    legend: { labelColor: '#8b949e', titleColor: '#c9d1d9' },
    view: { stroke: '#30363d' }
  };
  // Merge config into spec
  var themedSpec = Object.assign({}, spec, { config: darkConfig });
  try {
    vegaEmbed('#vis', themedSpec, { actions: { export: true, source: false, compiled: false, editor: false }, theme: 'dark' }).catch(function(e) {
      document.getElementById('statusText').textContent = 'Render error: ' + e;
    });
  } catch(e) {
    document.getElementById('statusText').textContent = 'Render exception: ' + e;
  }
}

function prettyJSON(obj) {
  try { return JSON.stringify(obj, null, 2); } catch(e) { return String(obj); }
}

function buildDataTable(rows) {
  var area = document.getElementById('dataPreviewArea');
  if (!rows || rows.length === 0) {
    area.innerHTML = '<div class="data-table-wrap"><table class="data-table"><thead><tr><th>No data</th></tr></thead></table></div>';
    return;
  }
  var cols = Object.keys(rows[0]);
  var html = '<div class="data-table-wrap"><table class="data-table"><thead><tr>';
  cols.forEach(function(c) { html += '<th>' + c + '</th>'; });
  html += '</tr></thead><tbody>';
  rows.slice(0, 50).forEach(function(row) {
    html += '<tr>';
    cols.forEach(function(c) {
      var v = row[c];
      if (typeof v === 'number') v = Number.isInteger(v) ? v : v.toFixed(4);
      html += '<td>' + (v != null ? v : '') + '</td>';
    });
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  if (rows.length > 50) html += '<div class="meta-value meta-value--secondary" style="margin-top:4px;">' + rows.length + ' rows total (showing first 50)</div>';
  area.innerHTML = html;
}

function renderProvenance(prov) {
  var el = document.getElementById('provArea');
  if (!prov) { el.innerHTML = '<div class="meta-value meta-value--secondary">None</div>'; return; }
  var html = '';

  // Sources
  if (prov.sources && prov.sources.length) {
    prov.sources.forEach(function(s) {
      html += '<div class="prov-item">';
      html += '<div class="prov-item-label">Source</div>';
      html += '<div class="prov-item-value">' + (s.source || 'unknown') + (s.symbol_or_key ? ' / ' + s.symbol_or_key : '') + '</div>';
      if (s.fetched_at) html += '<div class="prov-item-value" style="color:var(--text-muted);">' + s.fetched_at + '</div>';
      html += '</div>';
    });
  }

  // LLM calls
  if (prov.llm_calls && prov.llm_calls.length) {
    prov.llm_calls.forEach(function(c) {
      html += '<div class="prov-item">';
      html += '<div class="prov-item-label">' + (c.role || 'llm_call') + '</div>';
      html += '<div class="prov-item-value">model: ' + (c.model || 'n/a') + '</div>';
      if (c.response_id) html += '<div class="prov-item-value" style="color:var(--text-muted);">response_id: ' + c.response_id + '</div>';
      if (c.timestamp) html += '<div class="prov-item-value" style="color:var(--text-muted);">' + c.timestamp + '</div>';
      html += '</div>';
    });
  }

  // Connectors required
  if (prov.connectors_required && prov.connectors_required.length) {
    html += '<div class="prov-item">';
    html += '<div class="prov-item-label">Connectors</div>';
    prov.connectors_required.forEach(function(c) {
      html += '<div class="prov-item-value"><span class="tag tag--neutral">' + c + '</span></div>';
    });
    html += '</div>';
  }

  // API keys used
  if (prov.api_keys_required && prov.api_keys_required.length) {
    html += '<div class="prov-item">';
    html += '<div class="prov-item-label">API Keys Used</div>';
    prov.api_keys_required.forEach(function(k) {
      html += '<div class="prov-item-value"><span class="tag tag--warn">' + k + '</span></div>';
    });
    html += '</div>';
  }

  // Spec generator notes
  if (prov.spec_generator_notes) {
    html += '<div class="prov-item">';
    html += '<div class="prov-item-label">Spec Gen Notes</div>';
    html += '<div class="prov-item-value" style="color:var(--text-secondary);">' + prov.spec_generator_notes + '</div>';
    html += '</div>';
  }

  // Transforms
  if (prov.transforms && prov.transforms.length) {
    html += '<div class="prov-item">';
    html += '<div class="prov-item-label">Transforms</div>';
    prov.transforms.forEach(function(t) {
      html += '<div class="prov-item-value">' + t + '</div>';
    });
    html += '</div>';
  }

  // Request ID
  if (prov.request_id) {
    html += '<div class="prov-item">';
    html += '<div class="prov-item-label">Request ID</div>';
    html += '<div class="prov-item-value">' + prov.request_id + '</div>';
    html += '</div>';
  }

  // Parent request (replay)
  if (prov.parent_request_id) {
    html += '<div class="prov-item">';
    html += '<div class="prov-item-label">Parent Request</div>';
    html += '<div class="prov-item-value">' + prov.parent_request_id + '</div>';
    html += '</div>';
  }

  if (!html) html = '<div class="meta-value meta-value--secondary">No provenance entries.</div>';
  el.innerHTML = html;
}

function renderValidation(prov, details) {
  var el = document.getElementById('qualityArea');
  var tContainer = document.getElementById('transformActions');
  tContainer.innerHTML = '';

  if (prov && prov.validator) {
    var v = prov.validator;
    var html = '<div style="margin-bottom:6px;">';
    if (v.ok) {
      html += '<span class="tag tag--ok">PASS</span>';
    } else {
      html += '<span class="tag tag--err">FAIL</span>';
    }
    html += '</div>';
    if (v.errors && v.errors.length) {
      html += '<div class="meta-label" style="margin-top:8px;">Errors</div>';
      v.errors.forEach(function(e) { html += '<div class="meta-value" style="color:var(--danger); margin-bottom:2px;">' + e + '</div>'; });
    }
    if (v.warnings && v.warnings.length) {
      html += '<div class="meta-label" style="margin-top:8px;">Warnings</div>';
      v.warnings.forEach(function(w) { html += '<div class="meta-value" style="color:var(--warn); margin-bottom:2px;">' + w + '</div>'; });
    }
    el.innerHTML = html;
  } else if (details && details.quality_report) {
    showQuality(details.quality_report);
  } else {
    el.innerHTML = '<div class="meta-value meta-value--secondary">No validation results.</div>';
  }
}

var _lastSpec = null;

function handleSuccessResponse(json) {
  setTopbarStatus('OK ' + (json.request_id || '').slice(0, 8), 'ok');
  document.getElementById('statusText').textContent = json.request_id || '';

  var spec = json.spec || {};
  // Ensure spec has real inline data (LLMs sometimes emit placeholder URLs)
  if (json.data_preview && json.data_preview.length > 0) {
    spec.data = { values: json.data_preview };
  }
  _lastSpec = spec;
  renderVega(spec);
  buildDataTable(json.data_preview || []);
  renderProvenance(json.provenance || null);
  renderValidation(json.provenance || null, json.details || null);

  document.getElementById('specRaw').textContent = prettyJSON(spec);

  // Summary
  var sumHtml = '';
  sumHtml += '<div class="meta-block"><div class="meta-label">Status</div><div class="meta-value"><span class="tag tag--ok">SUCCESS</span></div></div>';
  if (json.explanation) {
    sumHtml += '<div class="meta-block"><div class="meta-label">Explanation</div><div class="meta-value" style="line-height:1.6;">' + json.explanation + '</div></div>';
  } else {
    sumHtml += '<div class="meta-block"><div class="meta-label">Caption</div><div class="meta-value">' + (json.caption || spec.description || 'n/a') + '</div></div>';
  }
  sumHtml += '<div class="meta-block"><div class="meta-label">Mark</div><div class="meta-value">' + (spec.mark || (spec.layer ? 'layered' : 'n/a')) + '</div></div>';
  sumHtml += '<div class="meta-block"><div class="meta-label">Rows</div><div class="meta-value">' + (json.data_preview || []).length + '</div></div>';
  sumHtml += '<div class="meta-block"><div class="meta-label">Request ID</div><div class="meta-value">' + (json.request_id || 'n/a') + '</div></div>';
  document.getElementById('summaryArea').innerHTML = sumHtml;

  // Show spec action buttons
  document.getElementById('specActions').style.display = 'flex';

  document.getElementById('downloadSpec').onclick = function() {
    var blob = new Blob([prettyJSON(spec)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (json.request_id || 'spec') + '.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  };
  document.getElementById('copySpec').onclick = function() {
    navigator.clipboard.writeText(prettyJSON(spec));
    document.getElementById('statusText').textContent = 'Spec JSON copied to clipboard.';
  };
}

// Generate
document.getElementById('go').onclick = async function() {
  var prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return;
  setTopbarStatus('EXECUTING...', 'neutral');
  document.getElementById('statusText').textContent = 'Sending request...';
  document.getElementById('clarifyArea').style.display = 'none';
  document.getElementById('specRaw').textContent = '';

  var resp = await postViz({ prompt: prompt });
  var json = resp.json;
  if (!json) {
    setTopbarStatus('ERROR', 'err');
    document.getElementById('statusText').textContent = 'No response from server.';
    return;
  }

  if (json.status === 'clarify_needed') {
    setTopbarStatus('CLARIFY', 'warn');
    document.getElementById('statusText').textContent = 'Clarification required.';
    document.getElementById('clarifyArea').style.display = 'block';
    document.getElementById('clarifyQuestionLabel').textContent = json.clarify_question || 'Please clarify your request.';
    document.getElementById('clarifyArea').dataset.origPrompt = prompt;
    return;
  }

  if (json.status === 'error') {
    setTopbarStatus('ERROR ' + (json.error_code || ''), 'err');
    document.getElementById('statusText').textContent = (json.error_code || '') + ': ' + (json.message || 'Unknown error');
    document.getElementById('specRaw').textContent = prettyJSON(json.details || json);
    renderProvenance(json.provenance || null);
    renderValidation(json.provenance || null, json.details || null);

    // Summary for errors
    var sumHtml = '';
    sumHtml += '<div class="meta-block"><div class="meta-label">Status</div><div class="meta-value"><span class="tag tag--err">ERROR</span> ' + (json.error_code || '') + '</div></div>';
    sumHtml += '<div class="meta-block"><div class="meta-label">Message</div><div class="meta-value">' + (json.message || '') + '</div></div>';
    document.getElementById('summaryArea').innerHTML = sumHtml;
    return;
  }

  handleSuccessResponse(json);
};

// Clear
document.getElementById('clear').onclick = function() {
  document.getElementById('prompt').value = '';
  document.getElementById('prompt').focus();
};

// Clarify answer
document.getElementById('answerClarify').onclick = async function() {
  var answer = document.getElementById('clarifyAnswer').value.trim();
  var orig = document.getElementById('clarifyArea').dataset.origPrompt || document.getElementById('prompt').value;
  if (!answer) return;
  document.getElementById('clarifyArea').style.display = 'none';
  document.getElementById('prompt').value = orig + ' -- ' + answer;
  document.getElementById('go').click();
};

// Enter key to submit
document.getElementById('prompt').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
    e.preventDefault();
    document.getElementById('go').click();
  }
});

function showQuality(report) {
  var el = document.getElementById('qualityArea');
  var tContainer = document.getElementById('transformActions');
  tContainer.innerHTML = '';
  if (!report) { el.innerHTML = '<div class="meta-value meta-value--secondary">No report</div>'; return; }
  var html = '<div style="margin-bottom:6px;">';
  html += report.ok ? '<span class="tag tag--ok">PASS</span>' : '<span class="tag tag--err">FAIL</span>';
  html += '</div>';
  if (report.metrics && report.metrics.n_rows !== undefined) html += '<div class="meta-block"><div class="meta-label">Rows</div><div class="meta-value">' + report.metrics.n_rows + '</div></div>';
  if (report.errors && report.errors.length) {
    html += '<div class="meta-label">Errors</div>';
    report.errors.forEach(function(e) { html += '<div class="meta-value" style="color:var(--danger);">' + (e.code || e) + ': ' + (e.message || '') + '</div>'; });
  }
  if (report.warnings && report.warnings.length) {
    html += '<div class="meta-label" style="margin-top:6px;">Warnings</div>';
    report.warnings.forEach(function(w) { html += '<div class="meta-value" style="color:var(--warn);">' + (w.code || w) + ': ' + (w.message || '') + '</div>'; });
  }

  if (report.errors && report.errors.some(function(e) { return e.code === 'E_TOO_MANY_POINTS'; })) {
    var b1 = document.createElement('button');
    b1.className = 'btn btn-sm';
    b1.textContent = 'Downsample';
    b1.onclick = async function() {
      setTopbarStatus('AUTOFIX...', 'neutral');
      document.getElementById('statusText').textContent = 'Requesting downsample...';
      var p = document.getElementById('prompt').value;
      var resp = await postAutofix({ prompt: p, autofix: { method: 'decimate' } });
      if (!resp.json) { document.getElementById('statusText').textContent = 'No response'; return; }
      if (resp.json.status === 'success') handleSuccessResponse(resp.json);
      else { setTopbarStatus('ERROR', 'err'); document.getElementById('statusText').textContent = 'Autofix failed: ' + (resp.json.message || ''); }
    };
    tContainer.appendChild(b1);

    var b2 = document.createElement('button');
    b2.className = 'btn btn-sm';
    b2.textContent = 'Resample Monthly';
    b2.onclick = async function() {
      setTopbarStatus('AUTOFIX...', 'neutral');
      document.getElementById('statusText').textContent = 'Requesting monthly resample...';
      var p = document.getElementById('prompt').value;
      var resp = await postAutofix({ prompt: p, autofix: { method: 'aggregate_monthly' } });
      if (!resp.json) { document.getElementById('statusText').textContent = 'No response'; return; }
      if (resp.json.status === 'success') handleSuccessResponse(resp.json);
      else { setTopbarStatus('ERROR', 'err'); document.getElementById('statusText').textContent = 'Autofix failed: ' + (resp.json.message || ''); }
    };
    tContainer.appendChild(b2);
  }

  el.innerHTML = html;
}
</script>
</body>
</html>
